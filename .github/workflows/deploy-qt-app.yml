name: Deploy Qt App
on:
  push:               # Run on push
  pull_request:       # Run on pull-request

jobs:
  build-windows:
    runs-on: windows-latest
    steps:

      - name: Checkout repository and submodules
        uses: actions/checkout@v2
        with:
          submodules: recursive


      - name: Extract project information
        shell: bash
        run: |
          cd utils
          chmod +x extract_cmake_project_info.sh
          PROJECT_INFO=$(./extract_cmake_project_info.sh ../CMakeLists.txt)
          echo "$PROJECT_INFO" >> $GITHUB_ENV
          echo "Printing project info"
          echo ${{env.PROJECT_NAME}}
          echo ${{env.PROJECT_VERSION}}

      - name: Install dependencies
        shell: bash
        run: |
          make dependency


      - name: Install Qt
        uses: jurplel/install-qt-action@v2
        with:
          aqtversion: '==3.1.*'
          version: '6.7.1'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw'
          modules: 'qtconnectivity qthttpserver qtmultimedia qtnetworkauth qtremoteobjects qtscxml'
          tools: 'tools_cmake,3.29.3-202405151154,qt.tools.cmake tools_ninja,1.12.0-202405151040,qt.tools.ninja'


      - name: Compile
        shell: bash
        run: |
          make build-release

      - name: Deploy
        shell: bash
        run: |
          make install DESTDIR=bin
          windeployqt bin/${{env.PROJECT_NAME}}.exe --compiler-runtime
          mkdir "${{env.PROJECT_NAME}}-${{env.PROJECT_VERSION}}"
          mv bin "${{env.PROJECT_NAME}}"

      - name: Packing
        shell: bash
        run: |
          7z a ${{env.PROJECT_NAME}}-${{env.PROJECT_VERSION}}.zip ${{env.PROJECT_NAME}}-${{env.PROJECT_VERSION}}


      - name: Upload
        uses: actions/upload-artifact@v2
        with:
          name: ${{env.PROJECT_NAME}}-${{env.PROJECT_VERSION}}
          path: ${{env.PROJECT_NAME}}-${{env.PROJECT_VERSION}}.zip
